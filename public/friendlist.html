<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Teman - SIPADAM</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="components.css">
  <link rel="stylesheet" href="friendlist.css">
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="container">
      <div class="logo">
        <a href="index.html">ğŸš’ SIPADAM</a>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="friendlist.html" class="active">ğŸ‘¥ Teman</a></li>
          <li><a href="laporan.html">ğŸ“‹ Laporan</a></li>
          <li><a href="profil.html">ğŸ‘¤ Profil</a></li>
          <li><a href="#" onclick="handleLogout()">ğŸšª Keluar</a></li>
        </ul>
      </nav>
      <div class="mobile-toggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="friendlist-container">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
      <h1>ğŸ‘¥ Status Keamanan Teman</h1>
      <p>Pantau kondisi teman dan keluarga Anda secara real-time</p>
    </div>

    <!-- Stats Summary -->
    <div class="stats-grid">
      <div class="stat-card safe">
        <div class="stat-icon">âœ…</div>
        <h2 id="countSafe">0</h2>
        <p>Aman</p>
      </div>
      <div class="stat-card warning">
        <div class="stat-icon">âš ï¸</div>
        <h2 id="countWarning">0</h2>
        <p>Waspada</p>
      </div>
      <div class="stat-card danger">
        <div class="stat-icon">ğŸ”¥</div>
        <h2 id="countDanger">0</h2>
        <p>Bahaya</p>
      </div>
      <div class="stat-card total">
        <div class="stat-icon">ğŸ“Š</div>
        <h2 id="countTotal">0</h2>
        <p>Total Teman</p>
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-section">
      <button class="filter-btn active" data-filter="all">
        <span>ğŸ“‹</span>
        <span>Semua</span>
      </button>
      <button class="filter-btn" data-filter="safe">
        <span>âœ…</span>
        <span>Aman</span>
      </button>
      <button class="filter-btn" data-filter="warning">
        <span>âš ï¸</span>
        <span>Waspada</span>
      </button>
      <button class="filter-btn" data-filter="danger">
        <span>ğŸ”¥</span>
        <span>Bahaya</span>
      </button>
    </div>

    <!-- Friends Grid -->
    <div class="friends-grid" id="friendsGrid">
      <!-- Will be populated by JavaScript -->
    </div>
  </div>

  <!-- Add Friend Button -->
  <button class="btn-add-friend" onclick="addFriend()" title="Tambah Teman">
    <span>+</span>
  </button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Check if socket.io is loaded
    let socket;
    try {
      socket = io();
    } catch (e) {
      console.warn('Socket.IO not available, running in offline mode');
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.textContent = message;
      const colors = { 
        success: '#10B981', 
        error: '#EF4444', 
        info: '#3B82F6', 
        warning: '#F59E0B' 
      };
      toast.style.cssText = `
        position: fixed; bottom: 30px; right: 30px; 
        background: ${colors[type]}; color: white; 
        padding: 16px 24px; border-radius: 12px; 
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        z-index: 10000; font-weight: 600; font-size: 0.95rem;
        animation: slideInRight 0.3s ease;
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Friends data with sensor info
    let friends = [
      { name: 'Andi Wijaya', location: 'Semarang Utara', status: 'safe', temp: 28, smoke: 0.12, co: 0.05 },
      { name: 'Budi Santoso', location: 'Semarang Tengah', status: 'safe', temp: 26, smoke: 0.09, co: 0.03 },
      { name: 'Citra Dewi', location: 'Semarang Selatan', status: 'warning', temp: 45, smoke: 0.35, co: 0.15 },
      { name: 'Dedi Kurniawan', location: 'Semarang Barat', status: 'safe', temp: 27, smoke: 0.10, co: 0.04 },
      { name: 'Eka Putri', location: 'Semarang Timur', status: 'danger', temp: 68, smoke: 0.78, co: 0.45 },
      { name: 'Fajar Ahmad', location: 'Semarang Utara', status: 'safe', temp: 29, smoke: 0.14, co: 0.06 },
      { name: 'Gita Maharani', location: 'Semarang Tengah', status: 'safe', temp: 25, smoke: 0.08, co: 0.02 },
      { name: 'Hendra Wijaya', location: 'Semarang Selatan', status: 'warning', temp: 42, smoke: 0.32, co: 0.12 }
    ];

    let currentFilter = 'all';

    // Render friends
    function renderFriends() {
      const friendsGrid = document.getElementById('friendsGrid');
      const filteredFriends = currentFilter === 'all' 
        ? friends 
        : friends.filter(f => f.status === currentFilter);

      if (filteredFriends.length === 0) {
        friendsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ˜”</div>
            <h3>Tidak ada teman dengan status ini</h3>
            <p>Coba filter lainnya untuk melihat status teman</p>
          </div>
        `;
        return;
      }

      friendsGrid.innerHTML = '';
      filteredFriends.forEach((friend, index) => {
        const initial = friend.name.charAt(0).toUpperCase();
        const statusConfig = {
          'safe': { icon: 'âœ…', text: 'Aman', class: 'safe' },
          'warning': { icon: 'âš ï¸', text: 'Waspada', class: 'warning' },
          'danger': { icon: 'ğŸ”¥', text: 'Bahaya', class: 'danger' }
        }[friend.status];

        const card = document.createElement('div');
        card.className = `friend-card ${friend.status}`;
        card.style.animationDelay = `${index * 0.05}s`;
        card.innerHTML = `
          <div class="friend-header">
            <div class="friend-avatar ${friend.status}">${initial}</div>
            <div class="friend-info">
              <h3>${friend.name}</h3>
              <div class="friend-location">ğŸ“ ${friend.location}</div>
            </div>
          </div>
          
          <div class="status-badge ${statusConfig.class}">
            <span>${statusConfig.icon}</span>
            <span>${statusConfig.text}</span>
          </div>

          <div class="sensor-data-grid">
            <div class="sensor-item temp">
              <div class="sensor-icon">ğŸŒ¡ï¸</div>
              <div class="sensor-details">
                <strong>${friend.temp}Â°C</strong>
                <span>Suhu</span>
              </div>
            </div>
            <div class="sensor-item smoke">
              <div class="sensor-icon">ğŸ’¨</div>
              <div class="sensor-details">
                <strong>${friend.smoke.toFixed(2)}</strong>
                <span>Asap</span>
              </div>
            </div>
            <div class="sensor-item co">
              <div class="sensor-icon">â˜ ï¸</div>
              <div class="sensor-details">
                <strong>${friend.co.toFixed(2)}</strong>
                <span>CO</span>
              </div>
            </div>
            <div class="sensor-item time">
              <div class="sensor-icon">â°</div>
              <div class="sensor-details">
                <strong>${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</strong>
                <span>Update</span>
              </div>
            </div>
          </div>
        `;
        friendsGrid.appendChild(card);
      });

      updateStats();
    }

    // Update stats
    function updateStats() {
      const countSafe = friends.filter(f => f.status === 'safe').length;
      const countWarning = friends.filter(f => f.status === 'warning').length;
      const countDanger = friends.filter(f => f.status === 'danger').length;

      document.getElementById('countSafe').textContent = countSafe;
      document.getElementById('countWarning').textContent = countWarning;
      document.getElementById('countDanger').textContent = countDanger;
      document.getElementById('countTotal').textContent = friends.length;
    }

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        renderFriends();
      });
    });

    // Add friend
    function addFriend() {
      const name = prompt('Masukkan nama teman:');
      if (name && name.trim()) {
        friends.push({
          name: name.trim(),
          location: 'Semarang',
          status: 'safe',
          temp: 27,
          smoke: 0.10,
          co: 0.04
        });
        renderFriends();
        showToast('âœ… Teman berhasil ditambahkan!', 'success');
      }
    }

    // Logout
    function handleLogout() {
      if (confirm('Apakah Anda yakin ingin keluar?')) {
        localStorage.removeItem('sipadam_user');
        showToast('âœ… Berhasil logout!', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
      }
    }

    // Mobile menu toggle
    const mobileToggle = document.querySelector('.mobile-toggle');
    const navMenu = document.querySelector('.navbar nav');

    if (mobileToggle && navMenu) {
      mobileToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
      });
    }

    // Navbar scroll effect
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.navbar');
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });

    // Initialize
    renderFriends();

    // Simulate real-time updates from sensor
    setInterval(() => {
      friends.forEach(friend => {
        const rand = Math.random();
        if (rand < 0.15) { // 15% chance to change
          friend.temp = 20 + Math.random() * 55;
          friend.smoke = Math.random() * 0.9;
          friend.co = Math.random() * 0.5;
          
          if (friend.temp > 60 || friend.smoke > 0.6 || friend.co > 0.3) {
            friend.status = 'danger';
          } else if (friend.temp > 40 || friend.smoke > 0.3 || friend.co > 0.15) {
            friend.status = 'warning';
          } else {
            friend.status = 'safe';
          }
        }
      });
      
      if (currentFilter === 'all' || friends.some(f => f.status === currentFilter)) {
        renderFriends();
      }
    }, 6000); // Update every 6 seconds

    // Add CSS animation keyframes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>