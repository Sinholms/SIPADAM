<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - SIPADAM</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="components.css">
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="sensor-status.css">
  <link rel="stylesheet" href="quick-actions.css">
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="container">
      <div class="logo">
        <a href="index.html">üöí SIPADAM</a>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html" class="active">Dashboard</a></li>
          <li><a href="friendlist.html">üë• Teman</a></li>
          <li><a href="laporan.html">üìã Laporan</a></li>
          <li><a href="profil.html">üë§ Profil</a></li>
          <li><a href="#" onclick="handleLogout()">üö™ Keluar</a></li>
        </ul>
      </nav>
      <div class="mobile-toggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>

  <!-- Dashboard Content -->
  <div class="dashboard-container">
    <!-- Welcome Banner -->
    <div class="welcome-banner">
      <h1>Selamat Datang, <span id="userName">Pengguna</span>! üëã</h1>
      <p>Pantau status keamanan area Anda secara real-time</p>
    </div>

    <!-- Main Grid Layout -->
    <div class="dashboard-grid">
      
      <!-- Main Content (Left Side) -->
      <div class="main-content">
        
        <!-- Camera Video Feed -->
        <div class="camera-video-card">
          <div class="video-wrapper" id="videoWrapper">
            <img id="videoStream" alt="Camera Feed" />
            
            <!-- Video Overlay -->
            <div class="video-overlay">
              <div class="video-status">
                <span class="status-dot"></span>
                <span id="streamStatus">OFFLINE</span>
              </div>
              <div class="video-time" id="videoTime">--:--:--</div>
            </div>
            
            <!-- Placeholder -->
            <div class="video-placeholder">
              <div class="placeholder-icon">üìπ</div>
              <div class="placeholder-text">Kamera Tidak Aktif</div>
              <div class="placeholder-subtext">Nyalakan kamera untuk mulai monitoring</div>
            </div>
          </div>
        </div>

        <!-- Sensor Status -->
        <div class="sensor-status-main status-safe" id="sensorStatusMain">
          <div class="status-icon" id="statusIcon">‚úÖ</div>
          <h2 id="statusText">AREA ANDA AMAN</h2>
          <p id="statusDescription">Tidak ada bahaya kebakaran terdeteksi di sekitar Anda</p>

          <div class="sensor-data-grid">
            <div class="sensor-data-item">
              <h4>üå° Suhu</h4>
              <div class="value" id="tempValue">--¬∞C</div>
            </div>
            <div class="sensor-data-item">
              <h4>üíß Kelembaban</h4>
              <div class="value" id="humValue" style="font-size: 1.3rem;" >--%</div>
            </div>
            <div class="sensor-data-item">
              <h4>üí® Asap</h4>
              <div class="value" id="smokeValue" style="font-size: 1.3rem;" >--ppm</div>
            </div>
            <div class="sensor-data-item">
              <h4>‚ò†Ô∏è CO</h4>
              <div class="value" id="coValue" style="font-size: 1.3rem;" >--ppm</div>
            </div>
            <div class="sensor-data-item">
              <h4>üå°üìà Temp Rate</h4>
              <div class="value" id="tempRate" style="font-size: 1.3rem;" >--¬∞C/s</div>
            </div>
            <div class="sensor-data-item">
              <h4>üí®üìà Smoke Rate</h4>
              <div class="value" id="smokeRate" style="font-size: 1.3rem;" >--ppm/s</div>
            </div>
            <div class="sensor-data-item">
              <h4>‚ò†Ô∏èüìà CO Rate</h4>
              <div class="value" id="coRate" style="font-size: 1.3rem;" >--ppm/s</div>
            </div>
            <div class="sensor-data-item">
              <h4>‚è∞ Update Terakhir</h4>
              <div class="value" id="lastUpdate" style="font-size: 1rem;">--:--:--</div>
            </div>
          </div>
        </div>

      </div>

      <!-- Sidebar (Right Side) -->
      <div class="sidebar-content">
        
        <!-- Camera Control Panel -->
        <div class="camera-control-panel">
          <div class="control-header">
            <div class="control-title">
              <span>üéÆ</span>
              <span>Kontrol Kamera</span>
            </div>
            <div class="status-indicator disconnected" id="statusIndicator">
              <span>‚ö´</span>
              <span id="statusText2">Disconnected</span>
            </div>
          </div>

          <div class="control-buttons">
            <button class="btn-control btn-start" id="btnStartCamera">
              <span>‚ñ∂Ô∏è</span>
              <span>Nyalakan</span>
            </button>
            <button class="btn-control btn-stop" id="btnStopCamera" disabled>
              <span>‚èπÔ∏è</span>
              <span>Matikan</span>
            </button>
          </div>

          <div class="camera-info-box">
            üí° <strong>AI Detection:</strong> Sistem akan otomatis mendeteksi kebakaran menggunakan teknologi YOLOv8
          </div>

          <!-- Fire Detection Alert -->
          <div class="fire-alert" id="fireAlert">
            <div class="fire-alert-content">
              <div class="fire-alert-icon">üî•</div>
              <div class="fire-alert-text">
                <div class="fire-alert-title">Api Terdeteksi!</div>
                <div class="fire-alert-stats">
                  Area: <strong id="fireArea">0</strong>px | 
                  Confidence: <strong id="fireConfidence">0</strong>%
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions" style="display: flex; flex-direction: column; gap: 12px;">
          <a href="laporan.html" class="action-card" style="padding: 20px;">
            <div class="icon" style="font-size: 2rem; width: 60px; height: 60px;">üö®</div>
            <h3 style="font-size: 1rem; margin-bottom: 4px;">Laporkan Kebakaran</h3>
            <p style="font-size: 0.85rem;">Kirim laporan darurat</p>
          </a>

          <a href="friendlist.html" class="action-card" style="padding: 20px;">
            <div class="icon" style="font-size: 2rem; width: 60px; height: 60px;">üë•</div>
            <h3 style="font-size: 1rem; margin-bottom: 4px;">Status Teman</h3>
            <p style="font-size: 0.85rem;">Cek kondisi keluarga</p>
          </a>

          <a href="tel:113" class="action-card" style="padding: 20px;">
            <div class="icon" style="font-size: 2rem; width: 60px; height: 60px;">üìû</div>
            <h3 style="font-size: 1rem; margin-bottom: 4px;">Hubungi Pemadam</h3>
            <p style="font-size: 0.85rem;">Telepon ke 113</p>
          </a>
        </div>

      </div>

    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  
  <script>
    // ==========================================
    // INITIALIZATION & LOGIN CHECK
    // ==========================================
    const socket = io();
    

    function handleLogout() {
      if (confirm('Apakah Anda yakin ingin keluar?')) {
        localStorage.removeItem('sipadam_user');
        alert('‚úÖ Anda telah keluar.');
        window.location.href = 'index.html';
      }
    }

    // Mobile menu toggle
    const mobileToggle = document.querySelector('.mobile-toggle');
    const navMenu = document.querySelector('.navbar nav');

    if (mobileToggle && navMenu) {
      mobileToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
      });
    }

    // Navbar scroll effect
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.navbar');
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });

    // Update video time
    setInterval(() => {
      const now = new Date();
      document.getElementById('videoTime').textContent = now.toLocaleTimeString('id-ID');
    }, 1000);

    // ==========================================
    // CAMERA CONTROL & VIDEO DISPLAY
    // ==========================================
    const btnStart = document.getElementById('btnStartCamera');
    const btnStop = document.getElementById('btnStopCamera');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText2 = document.getElementById('statusText2');
    const streamStatus = document.getElementById('streamStatus');
    const videoWrapper = document.getElementById('videoWrapper');
    const videoStream = document.getElementById('videoStream');
    const fireAlert = document.getElementById('fireAlert');
    const fireArea = document.getElementById('fireArea');
    const fireConfidence = document.getElementById('fireConfidence');
    
    let cameraActive = false;

    // Request status on load
    socket.emit('get-camera-status');

    // START Camera
    btnStart.addEventListener('click', () => {
      socket.emit('start-camera');
      btnStart.disabled = true;
      btnStart.innerHTML = '<span>‚è≥</span><span>Menghubungkan...</span>';
    });

    // STOP Camera
    btnStop.addEventListener('click', () => {
      socket.emit('stop-camera');
      btnStop.disabled = true;
      btnStop.innerHTML = '<span>‚è≥</span><span>Mematikan...</span>';
    });

    // Response from server
    socket.on('camera-response', (data) => {
      if (data.success) {
        console.log('‚úÖ Camera command sent:', data.message);
      }
    });

    // Update camera status
    socket.on('camera-status-update', (data) => {
      console.log('üì∑ Camera status:', data);
      
      if (data.enabled) {
        // Camera ON
        cameraActive = true;
        statusIndicator.className = 'status-indicator active';
        statusText2.textContent = 'Active';
        streamStatus.textContent = 'LIVE';
        videoWrapper.classList.add('streaming');
        
        btnStart.disabled = true;
        btnStart.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Nyalakan</span>';
        btnStop.disabled = false;
        btnStop.innerHTML = '<span>‚èπÔ∏è</span><span>Matikan</span>';
      } else {
        // Camera OFF
        cameraActive = false;
        videoWrapper.classList.remove('streaming');
        streamStatus.textContent = 'OFFLINE';
        
        if (data.status === 'disconnected') {
          statusIndicator.className = 'status-indicator disconnected';
          statusText2.textContent = 'Disconnected';
          btnStart.disabled = true;
          btnStop.disabled = true;
        } else {
          statusIndicator.className = 'status-indicator inactive';
          statusText2.textContent = 'Inactive';
          btnStart.disabled = false;
          btnStart.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Nyalakan</span>';
          btnStop.disabled = true;
          btnStop.innerHTML = '<span>‚èπÔ∏è</span><span>Matikan</span>';
        }
        
        fireAlert.classList.remove('active', 'critical');
        // Reset auto-report when camera stops
        autoReportSent = false;
      }
    });

    // Receive video stream
    socket.on('video-stream', (data) => {
      if (cameraActive) {
        videoStream.src = 'data:image/jpeg;base64,' + data.frame;
      }
    });

    // ==========================================
    // AUTO-REPORT SYSTEM
    // ==========================================
    let lastAutoReportTime = 0;
    const AUTO_REPORT_COOLDOWN = 60000; // 1 minute cooldown
    let criticalFireDetected = false;
    let autoReportSent = false;

    // Fire detection with AUTO-REPORT
    socket.on('fire-detection-update', (data) => {
      if (!cameraActive) return;
      
      console.log('üî• Fire detection update:', data);
      
      if (data.detected && data.area > 0) {
        fireAlert.classList.add('active');
        fireArea.textContent = data.area;
        fireConfidence.textContent = (data.confidence * 100).toFixed(1);
        
        // CRITICAL FIRE
        if (data.area > 15000) {
          fireAlert.classList.add('critical');
          criticalFireDetected = true;
          
          // ‚úÖ AUTO-REPORT
          const now = Date.now();
          if (!autoReportSent && (now - lastAutoReportTime) > AUTO_REPORT_COOLDOWN) {
            sendAutoReport(data);
          }
          
        } else {
          fireAlert.classList.remove('critical');
          criticalFireDetected = false;
        }
      } else {
        fireAlert.classList.remove('active', 'critical');
        criticalFireDetected = false;
        if (!data.detected) {
          autoReportSent = false;
        }
      }
    });

    // Send auto-report
    function sendAutoReport(fireData) {
      console.log('üö® CRITICAL FIRE - Sending auto-report...');
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            createAndSendReport(position.coords.latitude, position.coords.longitude, fireData);
          },
          () => {
            createAndSendReport(-6.9820, 110.4153, fireData);
          }
        );
      } else {
        createAndSendReport(-6.9820, 110.4153, fireData);
      }
    }

    function createAndSendReport(lat, lng, fireData) {
      const laporan = {
        lokasi: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
        catatan: `ü§ñ LAPORAN OTOMATIS KAMERA: Api besar terdeteksi! Area: ${fireData.area}px, Confidence: ${(fireData.confidence * 100).toFixed(1)}%. Segera tindak lanjut!`,
        waktu: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
        image: null,
        tipeLaporan: 'Auto',
        suhu: document.getElementById('tempValue').textContent,
        kelembaban: document.getElementById('humValue').textContent,
        intensitas: document.getElementById('smokeValue').textContent,
        co: document.getElementById('coValue').textContent,
        tempRate: document.getElementById('tempRate').textContent,
        smokeRate: document.getElementById('smokeRate').textContent,
        coRate: document.getElementById('coRate').textContent,
        riskLevel: 'CRITICAL_CAMERA'
      };

      socket.emit('laporan-baru', laporan);
      lastAutoReportTime = Date.now();
      autoReportSent = true;
      
      showAutoReportNotification();
      console.log('‚úÖ Auto-report sent');
    }

    function showAutoReportNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 100px; right: 30px;
        background: linear-gradient(135deg, #EF4444, #DC2626);
        color: white; padding: 20px 24px; border-radius: 12px;
        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        z-index: 10000; font-weight: 600; animation: slideInRight 0.3s ease;
      `;
      notification.innerHTML = `
        <div style="display: flex; gap: 12px;">
          <div style="font-size: 2rem;">üö®</div>
          <div>
            <div style="font-weight: 700; margin-bottom: 4px;">Laporan Otomatis Terkirim!</div>
            <div style="font-size: 0.85rem; opacity: 0.9;">Api kritis terdeteksi. Petugas diberitahu.</div>
          </div>
        </div>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // ==========================================
    // SENSOR DATA
    // ==========================================
    socket.on('data-sensor', (data) => {
      console.log("Data sensor:", data);
      updateSensorStatus(data);
    });

    socket.on('data-error', (error) => {
      console.error("Error sensor:", error.message);
      document.getElementById('lastUpdate').textContent = "Gagal Konek";
    });

    function updateSensorStatus(data) {
      const statusMain = document.getElementById('sensorStatusMain');
      const statusIcon = document.getElementById('statusIcon');
      const statusText = document.getElementById('statusText');
      const statusDesc = document.getElementById('statusDescription');
      
      // Update values
      document.getElementById('tempValue').textContent = data.temperature ? data.temperature + '¬∞C' : '--¬∞C';
      document.getElementById('smokeValue').textContent = data.smoke_ppm ? Number(data.smoke_ppm).toFixed(2) + 'ppm': '--';
      document.getElementById('humValue').textContent = data.humidity ? Number(data.humidity).toFixed(1) + '%': '--%';
      document.getElementById('coValue').textContent = data.co_ppm ? Number(data.co_ppm).toFixed(2) + "ppm": '--';
      document.getElementById('tempRate').textContent = data.tempRate ? Number(data.tempRate).toFixed(2) + '¬∞C/s': '--';
      document.getElementById('smokeRate').textContent = data.smokeRate ? Number(data.smokeRate).toFixed(2) + 'ppm/s' : '--';
      document.getElementById('coRate').textContent = data.coRate ? Number(data.coRate).toFixed(2) + 'ppm/s': '--';
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('id-ID');

      // Risk level logic
      let status = 'safe';
      let icon = '‚úÖ';
      let text = 'AREA ANDA AMAN';
      let desc = 'Tidak ada bahaya kebakaran terdeteksi di sekitar Anda';

      if (data.riskLevel === 'MEDIUM' || data.riskLevel === 'MEDIUM_CAMERA') {
        status = 'warning';
        icon = '‚ö†Ô∏è';
        text = 'WASPADA';
        desc = 'Tingkat bahaya sedang. Harap tetap waspada.';
      }

      if (data.riskLevel === 'HIGH' || data.riskLevel === 'CRITICAL' || 
          data.riskLevel === 'HIGH_CAMERA' || data.riskLevel === 'CRITICAL_CAMERA') {
        status = 'danger';
        icon = 'üî•';
        text = 'BAHAYA! EVAKUASI SEGERA';
        desc = 'Bahaya kebakaran terdeteksi! Hubungi pemadam (113)!';
      }

      statusMain.className = `sensor-status-main status-${status}`;
      statusIcon.textContent = icon;
      statusText.textContent = text;
      statusDesc.textContent = desc;
    }

    // Animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>