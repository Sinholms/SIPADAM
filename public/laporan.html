<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Kebakaran - SIPADAM</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="components.css">
  <link rel="stylesheet" href="laporan.css">
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="container">
      <div class="logo">
        <a href="index.html">ğŸš’ SIPADAM</a>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="friendlist.html">ğŸ‘¥ Teman</a></li>
          <li><a href="laporan.html" class="active">ğŸ“‹ Laporan</a></li>
          <li><a href="profil.html">ğŸ‘¤ Profil</a></li>
          <li><a href="#" onclick="handleLogout()">ğŸšª Keluar</a></li>
        </ul>
      </nav>
      <div class="mobile-toggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>

  <!-- Content -->
  <div class="laporan-container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>ğŸ”¥ Laporkan Kebakaran</h1>
      <p>Bantu kami merespons lebih cepat dengan informasi yang akurat</p>
    </div>

    <!-- Grid Layout -->
    <div class="laporan-grid">
      
      <!-- Main Content (Left Side) -->
      <div class="laporan-main">
        
        <!-- Map Card -->
        <div class="laporan-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ—ºï¸</span>
              <span>Lokasi Kebakaran</span>
            </div>
          </div>
          
          <div class="info-box">
            <div class="info-box-icon">ğŸ’¡</div>
            <div class="info-box-text">
              Klik pada peta untuk menandai lokasi kebakaran, atau gunakan tombol "Deteksi Lokasi" untuk menggunakan GPS Anda
            </div>
          </div>

          <div class="map-container" style="position: relative;">
            <div id="map"></div>
          </div>
        </div>

        <!-- Location Input Card -->
        <div class="location-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“</span>
              <span>Koordinat</span>
            </div>
          </div>
          
          <div class="location-input-group">
            <input type="text" id="inputLokasi" readonly placeholder="Klik peta atau deteksi lokasi">
            <button class="btn-detect-location" onclick="detectLocation()">
              ğŸ“¡ Deteksi Lokasi
            </button>
          </div>
          <div class="gps-status" id="statusGPS">
            â³ Menunggu lokasi...
          </div>
        </div>

        <!-- Description Card -->
        <div class="description-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“</span>
              <span>Deskripsi Kejadian</span>
            </div>
          </div>
          <textarea id="catatan" placeholder="Contoh: Api berasal dari dapur lantai 2, asap tebal, belum ada korban jiwa. Tolong segera datang!" rows="5"></textarea>
        </div>

        <!-- Photo Upload Card -->
        <div class="photo-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“¸</span>
              <span>Foto Kejadian (Opsional)</span>
            </div>
          </div>

          <label for="fotoKebakaran">
            <div class="photo-upload-area">
              <div class="photo-upload-icon">ğŸ“·</div>
              <div class="photo-upload-text">Klik untuk memilih foto</div>
              <div class="photo-upload-hint">Format: JPG, PNG (Maks 2MB)</div>
            </div>
          </label>
          <input type="file" id="fotoKebakaran" accept="image/*" onchange="handleFileSelect(event)">
          
          <div class="photo-preview" id="previewContainer">
            <img id="previewImage" src="" alt="Preview">
            <button type="button" class="remove-photo" onclick="removePhoto()">Ã—</button>
          </div>
        </div>

      </div>

      <!-- Sidebar (Right Side) -->
      <div class="laporan-sidebar">
        
        <!-- Sensor Data Card -->
        <div class="sensor-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“Š</span>
              <span>Data Sensor</span>
            </div>
          </div>
          
          <div class="sensor-grid">
            <div class="sensor-field">
              <label>ğŸŒ¡ï¸ Suhu</label>
              <input type="text" id="suhu" readonly placeholder="--Â°C">
            </div>
            
            <div class="sensor-field">
              <label>ğŸ’§ Kelembaban</label>
              <input type="text" id="kelembaban" readonly placeholder="--%">
            </div>

            <div class="sensor-field">
              <label>ğŸ’¨ Asap</label>
              <input type="text" id="intensitas" readonly placeholder="-- ppm">
            </div>

            <div class="sensor-field">
              <label>â˜ ï¸ CO</label>
              <input type="text" id="co" readonly placeholder="-- ppm">
            </div>

            <div class="sensor-field">
              <label>ğŸŒ¡ï¸ğŸ“ˆ Temp Rate</label>
              <input type="text" id="tempRate" readonly placeholder="--Â°C/s">
            </div>

            <div class="sensor-field">
              <label>ğŸ’¨ğŸ“ˆ Smoke Rate</label>
              <input type="text" id="smokeRate" readonly placeholder="-- ppm/s">
            </div>

            <div class="sensor-field">
              <label>â˜ ï¸ğŸ“ˆ CO Rate</label>
              <input type="text" id="coRate" readonly placeholder="-- ppm/s">
            </div>

            <div class="sensor-field">
              <label>âš ï¸ Level Bahaya</label>
              <input type="text" id="riskLevel" readonly placeholder="NORMAL">
            </div>
          </div>
        </div>

        <!-- Emergency Contacts -->
        <div class="emergency-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸš¨</span>
              <span>Kontak Darurat</span>
            </div>
          </div>

          <div class="emergency-grid">
            <a href="tel:113" class="emergency-item">
              <div class="emergency-icon">ğŸš’</div>
              <div class="emergency-info">
                <div class="emergency-name">Pemadam Kebakaran</div>
                <div class="emergency-number">113</div>
              </div>
            </a>

            <a href="tel:110" class="emergency-item">
              <div class="emergency-icon">ğŸ‘®</div>
              <div class="emergency-info">
                <div class="emergency-name">Polisi</div>
                <div class="emergency-number">110</div>
              </div>
            </a>

            <a href="tel:118" class="emergency-item">
              <div class="emergency-icon">ğŸš‘</div>
              <div class="emergency-info">
                <div class="emergency-name">Ambulans</div>
                <div class="emergency-number">118</div>
              </div>
            </a>
          </div>
        </div>

        <!-- Safety Tips -->
        <div class="tips-card">
          <div class="tips-title">
            <span>ğŸ’¡</span>
            <span>Tips Keselamatan</span>
          </div>
          <ul class="tips-list">
            <li>Tetap tenang dan jangan panik</li>
            <li>Evakuasi segera ke tempat aman</li>
            <li>Jangan kembali ke lokasi kebakaran</li>
            <li>Hubungi pemadam kebakaran (113)</li>
            <li>Bantu orang lain yang membutuhkan</li>
          </ul>
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
          <button type="button" class="btn-submit" onclick="submitLaporan()">
            <span>ğŸš¨</span>
            <span>Kirim Laporan Darurat</span>
          </button>
        </div>

      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  
  <script>

    // Socket.IO connection
    let socket;
    try {
      socket = io();
      console.log('âœ… Socket.IO connected');
      
      // Listen for sensor data
      socket.on('data-sensor', (data) => {
        updateSensorData(data);
      });
    } catch (e) {
      console.warn('âš ï¸ Socket.IO not available');
    }

    // Map initialization
    let map, marker;
    let selectedLat = -6.9820;
    let selectedLng = 110.4153;

    function initMap() {
      map = L.map('map').setView([selectedLat, selectedLng], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([selectedLat, selectedLng], { draggable: true }).addTo(map);
      
      document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;

      // Click on map
      map.on('click', function(e) {
        selectedLat = e.latlng.lat;
        selectedLng = e.latlng.lng;
        marker.setLatLng([selectedLat, selectedLng]);
        document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
        document.getElementById('statusGPS').textContent = 'âœ… Lokasi dipilih dari peta';
        document.getElementById('statusGPS').className = 'gps-status active';
      });

      // Drag marker
      marker.on('dragend', function(e) {
        selectedLat = e.target.getLatLng().lat;
        selectedLng = e.target.getLatLng().lng;
        document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
      });
    }

    // Detect location
    function detectLocation() {
      const statusEl = document.getElementById('statusGPS');
      statusEl.textContent = 'â³ Mendeteksi lokasi...';
      statusEl.className = 'gps-status';

      if (!navigator.geolocation) {
        statusEl.textContent = 'âŒ GPS tidak didukung browser';
        statusEl.className = 'gps-status error';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          selectedLat = position.coords.latitude;
          selectedLng = position.coords.longitude;
          
          marker.setLatLng([selectedLat, selectedLng]);
          map.setView([selectedLat, selectedLng], 15);
          
          document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
          statusEl.textContent = 'âœ… Lokasi terdeteksi';
          statusEl.className = 'gps-status active';
        },
        (error) => {
          statusEl.textContent = 'âŒ Gagal mendeteksi lokasi';
          statusEl.className = 'gps-status error';
          console.error('GPS Error:', error);
        }
      );
    }

    // Update sensor data
    function updateSensorData(data) {
      document.getElementById('suhu').value = data.temperature ? `${data.temperature}Â°C` : '--Â°C';
      document.getElementById('kelembaban').value = data.humidity ? `${data.humidity}%` : '--%';
      document.getElementById('intensitas').value = data.smoke_ppm ? `${data.smoke_ppm.toFixed(2)} ppm` : '-- ppm';
      document.getElementById('co').value = data.co_ppm ? `${data.co_ppm.toFixed(2)} ppm` : '-- ppm';
      document.getElementById('tempRate').value = data.tempRate ? `${data.tempRate.toFixed(1)}Â°C/s` : '--Â°C/s';
      document.getElementById('smokeRate').value = data.smokeRate ? `${data.smokeRate.toFixed(2)} ppm/s` : '-- ppm/s';
      document.getElementById('coRate').value = data.coRate ? `${data.coRate.toFixed(2)} ppm/s` : '-- ppm/s';
      document.getElementById('riskLevel').value = data.riskLevel || 'NORMAL';
    }

    // Photo upload
    let photoBase64 = null;

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('âŒ File harus berupa gambar!');
        event.target.value = '';
        return;
      }

      if (file.size > 2 * 1024 * 1024) {
        alert('âŒ Ukuran file maksimal 2MB!');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        photoBase64 = e.target.result;
        document.getElementById('previewImage').src = photoBase64;
        document.getElementById('previewContainer').classList.add('active');
      };
      reader.readAsDataURL(file);
    }

    function removePhoto() {
      photoBase64 = null;
      document.getElementById('fotoKebakaran').value = '';
      document.getElementById('previewContainer').classList.remove('active');
    }

    // Submit report
    function submitLaporan() {
      const lokasi = document.getElementById('inputLokasi').value;
      const catatan = document.getElementById('catatan').value;

      if (!lokasi) {
        alert('âš ï¸ Pilih lokasi kebakaran terlebih dahulu!');
        return;
      }

      const laporan = {
        lokasi: lokasi,
        catatan: catatan || 'Tidak ada catatan',
        waktu: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
        image: photoBase64 || null,
        tipeLaporan: 'Warga',
        suhu: document.getElementById('suhu').value,
        kelembaban: document.getElementById('kelembaban').value,
        intensitas: document.getElementById('intensitas').value,
        co: document.getElementById('co').value,
        tempRate: document.getElementById('tempRate').value,
        smokeRate: document.getElementById('smokeRate').value,
        coRate: document.getElementById('coRate').value,
        riskLevel: document.getElementById('riskLevel').value
      };

      if (socket) {
        socket.emit('laporan-baru', laporan);
      }

      // Save to localStorage
      const riwayat = JSON.parse(localStorage.getItem('sipadam_riwayat') || '[]');
      riwayat.unshift({
        ...laporan,
        tanggal: new Date().toLocaleDateString('id-ID'),
        status: 'Diterima'
      });
      localStorage.setItem('sipadam_riwayat', JSON.stringify(riwayat));

      alert('âœ… Laporan berhasil dikirim!\n\nPertugas pemadam kebakaran akan segera menuju lokasi.');
      
      // Reset form
      document.getElementById('catatan').value = '';
      removePhoto();
    }

    // Logout
    function handleLogout() {
      if (confirm('Apakah Anda yakin ingin keluar?')) {
        localStorage.removeItem('sipadam_user');
        window.location.href = 'index.html';
      }
    }

    // Mobile menu
    const mobileToggle = document.querySelector('.mobile-toggle');
    const navMenu = document.querySelector('.navbar nav');

    if (mobileToggle && navMenu) {
      mobileToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
      });
    }

    // Navbar scroll
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.navbar');
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });

    // Initialize
    window.addEventListener('load', () => {
      initMap();
      detectLocation();
    });
  </script>
</body>
</html>