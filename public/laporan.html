<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Kebakaran - SIPADAM</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>
  
  <link rel="stylesheet" href="base.css">
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="components.css">
  <link rel="stylesheet" href="laporan.css">
  
  <style>
    /* Fix untuk Leaflet map */
    #map {
      width: 100%;
      height: 400px;
      border-radius: var(--radius-lg);
      z-index: 1;
    }
    
    .leaflet-container {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="container">
      <div class="logo">
        <a href="index.html">ğŸš’ SIPADAM</a>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="friendlist.html">ğŸ‘¥ Teman</a></li>
          <li><a href="laporan.html" class="active">ğŸ“‹ Laporan</a></li>
          <li><a href="profil.html">ğŸ‘¤ Profil</a></li>
          <li><a href="#" onclick="handleLogout()">ğŸšª Keluar</a></li>
        </ul>
      </nav>
      <div class="mobile-toggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>

  <!-- Content -->
  <div class="laporan-container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>ğŸ”¥ Laporkan Kebakaran</h1>
      <p>Bantu kami merespons lebih cepat dengan informasi yang akurat</p>
    </div>

    <!-- Grid Layout -->
    <div class="laporan-grid">
      
      <!-- Main Content (Left Side) -->
      <div class="laporan-main">
        
        <!-- Map Card -->
        <div class="laporan-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ—ºï¸</span>
              <span>Lokasi Kebakaran</span>
            </div>
          </div>
          
          <div class="info-box">
            <div class="info-box-icon">ğŸ’¡</div>
            <div class="info-box-text">
              Lokasi diambil dari modul GPS IoT (fixed). Anda tetap bisa menggeser marker atau klik peta untuk ubah lokasi manual.
            </div>
          </div>

          <div class="map-container">
            <div id="map"></div>
          </div>
        </div>

        <!-- Location Input Card -->
        <div class="location-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“</span>
              <span>Koordinat</span>
            </div>
          </div>
          
          <div class="location-input-group">
            <input type="text" id="inputLokasi" readonly placeholder="Menunggu GPS IoT...">
            <button class="btn-detect-location" onclick="detectLocation()">
              ğŸ“± Fallback GPS
            </button>
          </div>
          <div class="gps-status" id="statusGPS">
            â³ Menunggu GPS dari modul IoT...
          </div>
        </div>

        <!-- Description Card -->
        <div class="description-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“</span>
              <span>Deskripsi Kejadian</span>
            </div>
          </div>
          <textarea id="catatan" placeholder="Contoh: Api berasal dari dapur lantai 2, asap tebal, belum ada korban jiwa. Tolong segera datang!" rows="5"></textarea>
        </div>

        <!-- Photo Upload Card -->
        <div class="photo-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“¸</span>
              <span>Foto Kejadian (Opsional)</span>
            </div>
          </div>

          <label for="fotoKebakaran">
            <div class="photo-upload-area">
              <div class="photo-upload-icon">ğŸ“·</div>
              <div class="photo-upload-text">Klik untuk memilih foto</div>
              <div class="photo-upload-hint">Format: JPG, PNG (Maks 2MB)</div>
            </div>
          </label>
          <input type="file" id="fotoKebakaran" accept="image/*" onchange="handleFileSelect(event)">
          
          <div class="photo-preview" id="previewContainer">
            <img id="previewImage" src="" alt="Preview">
            <button type="button" class="remove-photo" onclick="removePhoto()">Ã—</button>
          </div>
        </div>

      </div>

      <!-- Sidebar (Right Side) -->
      <div class="laporan-sidebar">
        
        <!-- Sensor Data Card -->
        <div class="sensor-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸ“Š</span>
              <span>Data Sensor</span>
            </div>
          </div>
          
          <div class="sensor-grid">
            <div class="sensor-field">
              <label>ğŸŒ¡ï¸ Suhu</label>
              <input type="text" id="suhu" readonly placeholder="--Â°C">
            </div>
            
            <div class="sensor-field">
              <label>ğŸ’§ Kelembaban</label>
              <input type="text" id="kelembaban" readonly placeholder="--%">
            </div>

            <div class="sensor-field">
              <label>ğŸ’¨ Asap</label>
              <input type="text" id="intensitas" readonly placeholder="-- ppm">
            </div>

            <div class="sensor-field">
              <label>â˜ ï¸ CO</label>
              <input type="text" id="co" readonly placeholder="-- ppm">
            </div>

            <div class="sensor-field">
              <label>ğŸŒ¡ï¸ğŸ“ˆ Temp Rate</label>
              <input type="text" id="tempRate" readonly placeholder="--Â°C/s">
            </div>

            <div class="sensor-field">
              <label>ğŸ’¨ğŸ“ˆ Smoke Rate</label>
              <input type="text" id="smokeRate" readonly placeholder="-- ppm/s">
            </div>

            <div class="sensor-field">
              <label>â˜ ï¸ğŸ“ˆ CO Rate</label>
              <input type="text" id="coRate" readonly placeholder="-- ppm/s">
            </div>

            <div class="sensor-field">
              <label>âš ï¸ Level Bahaya</label>
              <input type="text" id="riskLevel" readonly placeholder="NORMAL">
            </div>
          </div>
        </div>

        <!-- Emergency Contacts -->
        <div class="emergency-card">
          <div class="card-header">
            <div class="card-title">
              <span>ğŸš¨</span>
              <span>Kontak Darurat</span>
            </div>
          </div>

          <div class="emergency-grid">
            <a href="tel:113" class="emergency-item">
              <div class="emergency-icon">ğŸš’</div>
              <div class="emergency-info">
                <div class="emergency-name">Pemadam Kebakaran</div>
                <div class="emergency-number">113</div>
              </div>
            </a>

            <a href="tel:110" class="emergency-item">
              <div class="emergency-icon">ğŸ‘®</div>
              <div class="emergency-info">
                <div class="emergency-name">Polisi</div>
                <div class="emergency-number">110</div>
              </div>
            </a>

            <a href="tel:118" class="emergency-item">
              <div class="emergency-icon">ğŸš‘</div>
              <div class="emergency-info">
                <div class="emergency-name">Ambulans</div>
                <div class="emergency-number">118</div>
              </div>
            </a>
          </div>
        </div>

        <!-- Safety Tips -->
        <div class="tips-card">
          <div class="tips-title">
            <span>ğŸ’¡</span>
            <span>Tips Keselamatan</span>
          </div>
          <ul class="tips-list">
            <li>Tetap tenang dan jangan panik</li>
            <li>Evakuasi segera ke tempat aman</li>
            <li>Jangan kembali ke lokasi kebakaran</li>
            <li>Hubungi pemadam kebakaran (113)</li>
            <li>Bantu orang lain yang membutuhkan</li>
          </ul>
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
          <button type="button" class="btn-submit" onclick="submitLaporan()">
            <span>ğŸš¨</span>
            <span>Kirim Laporan Darurat</span>
          </button>
        </div>

      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script src="/socket.io/socket.io.js"></script>
  
  <script>
    // ============================================
    // LAPORAN.HTML - GPS dari IoT Module NEO-6M
    // ============================================

    // Socket.IO connection
    let socket;
    try {
      socket = io();
      console.log('âœ… Socket.IO connected');
    } catch (e) {
      console.warn('âš ï¸ Socket.IO not available');
    }

    // ===== VARIABLES =====
    let map, marker;
    let selectedLat = -6.9820; // Semarang default
    let selectedLng = 110.4153;
    let photoBase64 = null;
    
    // GPS Source Tracking
    let gpsSource = 'none';
    let iotGpsValid = false;
    let lastIotGpsUpdate = 0;
    const GPS_TIMEOUT = 10000;
    
    // Auto Report Tracking
    let lastAutoReportTime = 0;
    let hasAutoReported = false;
    const AUTO_REPORT_COOLDOWN = 300000;
    let userHasInteracted = false;

    // ===== GPS STATUS UPDATE =====
    function updateGPSStatus(source, isValid, message) {
      gpsSource = source;
      const statusEl = document.getElementById('statusGPS');
      
      if (source === 'iot' && isValid) {
        statusEl.innerHTML = `
          <span style="color: #2e7d32; font-weight: 600;">ğŸ›°ï¸ GPS IoT Module Active</span><br>
          <span style="color: #666; font-size: 0.85em;">Koordinat dari modul NEO-6M</span>
        `;
        statusEl.style.backgroundColor = '#e8f5e9';
        statusEl.style.padding = '12px';
        statusEl.style.borderRadius = '8px';
      } else if (source === 'device' && isValid) {
        statusEl.innerHTML = `
          <span style="color: #ff9800; font-weight: 600;">ğŸ“± GPS Device (Fallback)</span><br>
          <span style="color: #666; font-size: 0.85em;">Menggunakan GPS perangkat</span>
        `;
        statusEl.style.backgroundColor = '#fff3e0';
      } else if (source === 'manual') {
        statusEl.innerHTML = `
          <span style="color: #2196f3; font-weight: 600;">ğŸ“ Manual Location</span><br>
          <span style="color: #666; font-size: 0.85em;">Lokasi dipilih dari peta</span>
        `;
        statusEl.style.backgroundColor = '#e3f2fd';
      } else {
        statusEl.innerHTML = `
          <span style="color: #e63946; font-weight: 600;">âŒ GPS Tidak Tersedia</span><br>
          <span style="color: #666; font-size: 0.85em;">Klik peta untuk menandai lokasi manual</span>
        `;
        statusEl.style.backgroundColor = '#ffebee';
      }
    }

    // ===== TRACK USER INTERACTIONS =====
    function markUserInteraction() {
      userHasInteracted = true;
      hasAutoReported = false;
    }

    // ===== MAP INITIALIZATION =====
    function initMap() {
      console.log('ğŸ—ºï¸ Initializing map...');
      
      try {
        // Create map
        map = L.map('map', {
          center: [selectedLat, selectedLng],
          zoom: 13,
          zoomControl: true,
          attributionControl: true
        });
        
        console.log('âœ… Map created');

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
        
        console.log('âœ… Tile layer added');

        // Add marker
        marker = L.marker([selectedLat, selectedLng], { 
          draggable: true 
        }).addTo(map);
        
        console.log('âœ… Marker added');
        
        // Update input
        document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;

        // Force map to render
        setTimeout(() => {
          map.invalidateSize();
          console.log('âœ… Map size invalidated');
        }, 250);

        // ===== EVENT LISTENERS =====
        
        // Zoom
        map.on('zoomstart', function() {
          markUserInteraction();
        });
        
        // Pan/Drag map
        map.on('dragstart', function() {
          markUserInteraction();
        });
        
        // Click on map
        map.on('click', function(e) {
          selectedLat = e.latlng.lat;
          selectedLng = e.latlng.lng;
          marker.setLatLng([selectedLat, selectedLng]);
          document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
          updateGPSStatus('manual', true);
          markUserInteraction();
        });

        // Drag marker
        marker.on('dragstart', function() {
          markUserInteraction();
        });
        
        marker.on('dragend', function(e) {
          selectedLat = e.target.getLatLng().lat;
          selectedLng = e.target.getLatLng().lng;
          document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
          updateGPSStatus('manual', true);
        });

        console.log('âœ… Map fully initialized');
        
      } catch (error) {
        console.error('âŒ Map initialization error:', error);
      }
    }

    // ===== DETECT DEVICE LOCATION (FALLBACK) =====
    function detectLocation() {
      const statusEl = document.getElementById('statusGPS');
      statusEl.textContent = 'â³ Mendeteksi lokasi dari device...';

      if (!navigator.geolocation) {
        updateGPSStatus('none', false);
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          selectedLat = position.coords.latitude;
          selectedLng = position.coords.longitude;
          
          marker.setLatLng([selectedLat, selectedLng]);
          map.setView([selectedLat, selectedLng], 15);
          
          document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
          updateGPSStatus('device', true);
          markUserInteraction();
        },
        (error) => {
          updateGPSStatus('none', false);
          console.error('GPS Error:', error);
        }
      );
    }

    // ===== RECEIVE DATA FROM IoT =====
    if (socket) {
      socket.on('data-sensor', (data) => {
        console.log('ğŸ“¡ Data sensor:', data);

        // ===== GPS dari IoT Module =====
        if (data.gpsValid && data.latitude !== 0 && data.longitude !== 0 && !userHasInteracted) {
          const latDiff = Math.abs(selectedLat - data.latitude);
          const lngDiff = Math.abs(selectedLng - data.longitude);
                
          if (latDiff > 0.0001 || lngDiff > 0.0001 || gpsSource === 'none') {
            selectedLat = data.latitude;
            selectedLng = data.longitude;
            document.getElementById('inputLokasi').value = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
            
            iotGpsValid = true;
            lastIotGpsUpdate = Date.now();
            updateGPSStatus('iot', true);
            
            if (marker) {
              marker.setLatLng([selectedLat, selectedLng]);
              map.setView([selectedLat, selectedLng], 16);
            }
            
            console.log('ğŸ›°ï¸ GPS IoT Fixed Location:', selectedLat, selectedLng);
          }
        }

        // Update sensor readings
        document.getElementById('suhu').value = data.temperature ? `${data.temperature.toFixed(1)}Â°C` : '--Â°C';
        document.getElementById('kelembaban').value = data.humidity ? `${data.humidity.toFixed(1)}%` : '--%';
        document.getElementById('intensitas').value = data.smoke_ppm ? `${data.smoke_ppm.toFixed(2)} ppm` : '-- ppm';
        document.getElementById('co').value = data.co_ppm ? `${data.co_ppm.toFixed(2)} ppm` : '-- ppm';
        document.getElementById('tempRate').value = data.tempRate ? `${data.tempRate.toFixed(2)}Â°C/s` : '--Â°C/s';
        document.getElementById('smokeRate').value = data.smokeRate ? `${data.smokeRate.toFixed(2)} ppm/s` : '-- ppm/s';
        document.getElementById('coRate').value = data.coRate ? `${data.coRate.toFixed(2)} ppm/s` : '-- ppm/s';
        
        const riskLevelInput = document.getElementById('riskLevel');
        riskLevelInput.value = data.riskLevel || 'NORMAL';
        
        // Styling risk level
        if (data.riskLevel === 'CRITICAL') {
          riskLevelInput.style.backgroundColor = '#ffe0e0';
          riskLevelInput.style.color = '#e63946';
          riskLevelInput.style.fontWeight = 'bold';
        } else if (data.riskLevel === 'HIGH') {
          riskLevelInput.style.backgroundColor = '#fff3cd';
          riskLevelInput.style.color = '#ff9800';
          riskLevelInput.style.fontWeight = 'bold';
        } else if (data.riskLevel === 'MEDIUM') {
          riskLevelInput.style.backgroundColor = '#fff8e1';
          riskLevelInput.style.color = '#f57c00';
          riskLevelInput.style.fontWeight = '600';
        } else {
          riskLevelInput.style.backgroundColor = '#e8f5e9';
          riskLevelInput.style.color = '#2e7d32';
          riskLevelInput.style.fontWeight = 'normal';
          hasAutoReported = false;
        }

        // Auto Report Trigger
        if (shouldTriggerAutoReport(data.riskLevel) && !hasAutoReported && !userHasInteracted) {
          sendAutoReport(data);
        }
      });
    }

    // ===== AUTO REPORT FUNCTIONS =====
    function shouldTriggerAutoReport(riskLevel) {
      if (riskLevel !== 'HIGH' && riskLevel !== 'CRITICAL') {
        return false;
      }
      
      const now = Date.now();
      if (now - lastAutoReportTime < AUTO_REPORT_COOLDOWN) {
        console.log('â³ Auto-report cooldown active...');
        return false;
      }
      
      return true;
    }

    function sendAutoReport(data) {
      console.log('ğŸš¨ TRIGGERING AUTO REPORT!');
      
      if (!selectedLat || !selectedLng) {
        console.warn('âŒ No GPS coordinates, auto-report cancelled');
        return;
      }
      
      const lokasi = `${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
      const waktu = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
      
      const laporan = {
        lokasi: lokasi,
        catatan: `âš ï¸ LAPORAN OTOMATIS (GPS: ${gpsSource.toUpperCase()}) - Level bahaya ${data.riskLevel} terdeteksi!`,
        waktu: waktu,
        image: null,
        tipeLaporan: 'Auto',
        suhu: data.temperature ? `${data.temperature.toFixed(1)}Â°C` : '--Â°C',
        kelembaban: data.humidity ? `${data.humidity.toFixed(1)}%` : '--%',
        intensitas: data.smoke_ppm ? `${data.smoke_ppm.toFixed(2)} ppm` : '-- ppm',
        co: data.co_ppm ? `${data.co_ppm.toFixed(2)} ppm` : '-- ppm',
        tempRate: data.tempRate ? `${data.tempRate.toFixed(2)}Â°C/s` : '--Â°C/s',
        smokeRate: data.smokeRate ? `${data.smokeRate.toFixed(2)} ppm/s` : '-- ppm/s',
        coRate: data.coRate ? `${data.coRate.toFixed(2)} ppm/s` : '-- ppm/s',
        riskLevel: data.riskLevel
      };
      
      if (socket) {
        socket.emit('laporan-baru', laporan);
      }
      
      lastAutoReportTime = Date.now();
      hasAutoReported = true;
      
      alert(`ğŸš¨ Laporan otomatis terkirim!\nGPS: ${gpsSource.toUpperCase()}\nLevel: ${data.riskLevel}`);
    }

    // ===== PHOTO UPLOAD =====
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('âŒ File harus berupa gambar!');
        event.target.value = '';
        return;
      }

      if (file.size > 2 * 1024 * 1024) {
        alert('âŒ Ukuran file maksimal 2MB!');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        photoBase64 = e.target.result;
        document.getElementById('previewImage').src = photoBase64;
        document.getElementById('previewContainer').classList.add('active');
      };
      reader.readAsDataURL(file);
    }

    function removePhoto() {
      photoBase64 = null;
      document.getElementById('fotoKebakaran').value = '';
      document.getElementById('previewContainer').classList.remove('active');
    }

    // ===== SUBMIT REPORT =====
    function submitLaporan() {
      const lokasi = document.getElementById('inputLokasi').value;
      const catatan = document.getElementById('catatan').value;

      if (!lokasi) {
        alert('âš ï¸ Pilih lokasi kebakaran terlebih dahulu!');
        return;
      }

      const laporan = {
        lokasi: lokasi,
        catatan: catatan || `Laporan dari GPS ${gpsSource.toUpperCase()}`,
        waktu: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
        image: photoBase64 || null,
        tipeLaporan: 'Warga',
        suhu: document.getElementById('suhu').value,
        kelembaban: document.getElementById('kelembaban').value,
        intensitas: document.getElementById('intensitas').value,
        co: document.getElementById('co').value,
        tempRate: document.getElementById('tempRate').value,
        smokeRate: document.getElementById('smokeRate').value,
        coRate: document.getElementById('coRate').value,
        riskLevel: document.getElementById('riskLevel').value
      };

      if (socket) {
        socket.emit('laporan-baru', laporan);
      }

      // Save to localStorage
      const riwayat = JSON.parse(localStorage.getItem('sipadam_riwayat') || '[]');
      riwayat.unshift({
        ...laporan,
        tanggal: new Date().toLocaleDateString('id-ID'),
        status: 'Diterima'
      });
      localStorage.setItem('sipadam_riwayat', JSON.stringify(riwayat));

      alert(`âœ… Laporan berhasil dikirim!\nGPS Source: ${gpsSource.toUpperCase()}\n\nPertugas akan segera menuju lokasi.`);
      
      // Reset form
      document.getElementById('catatan').value = '';
      removePhoto();
    }

    // ===== LOGOUT =====
    function handleLogout() {
      if (confirm('Apakah Anda yakin ingin keluar?')) {
        localStorage.removeItem('sipadam_user');
        window.location.href = 'index.html';
      }
    }

    // ===== MOBILE MENU =====
    const mobileToggle = document.querySelector('.mobile-toggle');
    const navMenu = document.querySelector('.navbar nav');

    if (mobileToggle && navMenu) {
      mobileToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
      });
    }

    // ===== NAVBAR SCROLL =====
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.navbar');
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });

    // ===== INITIALIZE =====
    window.addEventListener('load', () => {
      console.log('ğŸš€ Page loaded, initializing...');
      
      // Wait for DOM to be ready
      setTimeout(() => {
        initMap();
        updateGPSStatus('none', false);
      }, 100);
    });
  </script>
</body>
</html>