<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Laporan - SIPADAM</title>
    
    <link rel="stylesheet" href="detail-laporan.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="icon">üî•</span>
          <div class="logo-text">
            <h2>SIPADAM</h2>
            <p>Sistem Peringatan Dini</p>
          </div>
        </div>
      </div>
      <ul class="menu">
        <li>
          <a href="dashboard.html">
            <span>üìä</span><span class="menu-text">Dashboard</span>
          </a>
        </li>
        <li class="active">
          <a href="laporan.html">
            <span>üìã</span><span class="menu-text">Laporan</span>
          </a>
        </li>
        <li>
          <a href="profil.html">
            <span>üë§</span><span class="menu-text">Profil</span>
          </a>
        </li>
        <li>
          <a href="login.html">
            <span>üö™</span><span class="menu-text">Keluar</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="main-content">
      <header>
        <div class="header-left">
          <div class="menu-toggle" id="menu-toggle-btn">‚ò∞</div>
          <h1>Detail Laporan</h1>
        </div>
        
        <div class="user-info">
          <div class="notification-area">
            <a href="#" class="notif" id="notificationBell">
              üîî<span class="badge" id="notificationBadge"></span>
            </a>
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="dropdown-header">
                <h3>Notifikasi Terbaru</h3>
                <span class="clear-all" id="clearAllNotifications">Bersihkan Semua</span>
              </div>
              <div class="dropdown-list" id="notificationList">
                </div>
              <div class="dropdown-footer">
                <a href="laporan.html">Lihat Semua Laporan</a>
              </div>
            </div>
          </div>
          <a href="profil.html" class="user"> üë©‚Äçüöí Petugas Pemadam </a>
          <span class="status online">Online</span>
        </div>
      </header>

      <button class="back-btn" onclick="window.location.href='laporan.html'">
        ‚¨Ö Kembali ke Daftar Laporan
      </button>

      <div class="content-wrapper">
        
        <div class="left-section">
          <div class="report-summary">
            <div class="report-header">
              <h2 id="judulLaporan">Memuat Laporan...</h2>
              <span class="status-badge" id="statusLaporan">...</span>
            </div>
            <p class="time" id="waktuLaporan">--</p>

            <div class="metrics-container" style="display: flex; flex-direction: column; gap: 15px;">
              
              <div class="metrics"> 
                <div class="metric red">
                  <p>üî• Suhu</p>
                  <h3 id="suhu">--¬∞C</h3>
                </div>
                <div class="metric blue">
                  <p>üíß Kelembaban</p>
                  <h3 id="kelembaban">--%</h3>
                </div>
                <div class="metric orange">
                  <p>üí® Asap</p>
                  <h3 id="intensitas">--</h3>
                </div>
                <div class="metric" style="background: #e8f5e9; color: #2e7d32;">
                  <p>‚ò†Ô∏è CO (Racun)</p>
                  <h3 id="co">--</h3>
                </div>
              </div>
            
              <div class="metrics">
                <div class="metric" style="background: #fff3e0; color: #ef6c00;">
                  <p>üìà Naik Suhu</p>
                  <h3 id="tempRate">--</h3>
                </div>
                <div class="metric" style="background: #fff3e0; color: #ef6c00;">
                  <p>üìà Naik Asap</p>
                  <h3 id="smokeRate">--</h3>
                </div>
                <div class="metric" style="background: #ffebee; color: #c62828; border: 2px solid #ef5350;">
                  <p>‚ö†Ô∏è RISK LEVEL</p>
                  <h3 id="riskLevel">NORMAL</h3>
                </div>
              </div>
            
            </div>
          </div>

          <div class="info-card">
            <h3>Informasi Lokasi</h3>
            <p><b>Alamat / Koordinat:</b><br /><span id="alamat">Memuat...</span></p>
            
            <p><b>Link Peta:</b><br /><span id="koordinat">--</span></p>
            
            <iframe
              id="mapFrame"
              width="100%"
              height="250"
              style="border: 0; border-radius: 8px; margin-top: 10px; display: none;"
              loading="lazy"
            ></iframe>

            <p style="margin-top:15px;"><b>Deskripsi Kejadian:</b><br /><span id="deskripsi">--</span></p>
            <p><b>Pelapor:</b> <span id="pelapor">--</span></p>
          </div>

          <div class="info-card">
            <h3>Dokumentasi Kejadian</h3>
            <div class="gallery-container" id="galleryContainer"></div>
          </div>
        </div>

        <div class="right-section">
          <div class="action-card" id="action-card">
            <h3>Aksi Status</h3>
            <button class="status-btn yellow" id="btn-handle">üü° Tandai Sedang Ditangani</button>
            <button class="status-btn green" id="btn-done">üü¢ Tandai Selesai</button>
            <button class="status-btn red" id="btn-activate">üî• Aktifkan Kembali Laporan</button>
          </div>
          
          <div class="info-card quick-info">
            <h3>Informasi Cepat</h3>
            <p><b>ID Laporan:</b> <span id="idLaporan">--</span></p>
            <p><b>Waktu Laporan:</b> <span id="jamLaporan">--</span></p>
            <p><b>Prioritas:</b> <span class="priority low" id="prioritas">Rendah</span></p>
          </div>
        </div>
      </div>
    </div> 
    
   <script src="main.js"></script>

   <script>
      document.addEventListener('DOMContentLoaded', () => {
        
        // ============================================
        // 1. INISIALISASI & KONEKSI SOCKET
        // ============================================
        const socket = io();
        
        // PENTING: Beritahu server kita adalah ADMIN
        socket.emit('admin-bergabung'); 

        const params = new URLSearchParams(window.location.search);
        const laporanId = params.get("id");

        // UI Elements
        const btnHandle = document.getElementById('btn-handle');
        const btnDone = document.getElementById('btn-done');
        const btnActivate = document.getElementById('btn-activate');

        // VARIABLE FLAG: Untuk mencegah notifikasi ganda
        let isMyAction = false; 

        if (!laporanId) {
            document.querySelector('.main-content').innerHTML = "<h1>Error: ID Laporan tidak ditemukan di URL.</h1>";
            return;
        }

        // ============================================
        // 2. FUNGSI UPDATE TAMPILAN (UI)
        // ============================================
        function updateUI(data) {
            // Header & Status
            document.getElementById("judulLaporan").textContent = `Laporan #${data._id.slice(-4)} - ${data.lokasi}`;
            const statusBadge = document.getElementById("statusLaporan");
            statusBadge.textContent = data.status;
            statusBadge.className = `status-badge ${getStatusColor(data.status)}`;
            
            // Tanggal
            const tanggalLengkap = formatTanggalDariID(data._id);
            document.getElementById("waktuLaporan").textContent = tanggalLengkap;
            document.getElementById("jamLaporan").textContent = tanggalLengkap;
            document.getElementById("idLaporan").textContent = `#${data._id}`;

            // Data Sensor
            document.getElementById("suhu").textContent = data.suhu || '--¬∞C';
            document.getElementById("kelembaban").textContent = data.kelembaban || '--%';
            document.getElementById("intensitas").textContent = data.intensitas || '-- ppm';
            document.getElementById("co").textContent = data.co || '-- ppm';
            document.getElementById("tempRate").textContent = data.tempRate || '--';
            document.getElementById("smokeRate").textContent = data.smokeRate || '--';
            
            // Risk Level & Prioritas
            updateRiskAndPriority(data.riskLevel);

            // Info Lokasi
            document.getElementById("alamat").textContent = data.lokasi;
            document.getElementById("deskripsi").textContent = data.catatan || 'Tidak ada deskripsi.';
            document.getElementById("pelapor").textContent = data.tipeLaporan === 'Sensor' ? 'ü§ñ Sensor IoT Otomatis' : 'üë§ Warga';

            // Peta & Gallery
            updateMap(data.lokasi);
            updateGallery(data.image);

            // Update Tombol
            updateButtons(data.status);
        }

        // ============================================
        // 3. LOGIKA TOMBOL AKSI (PERBAIKAN NOTIFIKASI GANDA)
        // ============================================
        window.changeStatus = async function(newStatus) {
            // SET FLAG: Ini aksi kita sendiri
            isMyAction = true;

            // Matikan tombol sementara
            const allBtns = document.querySelectorAll('.status-btn');
            allBtns.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`/api/laporan/${laporanId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });

                if(!response.ok) throw new Error("Gagal update status");

                // Langsung ambil data terbaru & Update UI
                const dataTerbaru = await response.json();
                updateUI(dataTerbaru);
                
                // Tampilkan notifikasi SUKSES (Hanya dari sini)
                if(typeof showToastNotification === 'function') {
                    showToastNotification({ title: 'Status Berhasil Diubah', time: 'Baru saja', icon: '‚úÖ' });
                }

                // Reset flag setelah delay aman (2 detik)
                setTimeout(() => { isMyAction = false; }, 2000);

            } catch (err) {
                console.error(err);
                alert("Gagal koneksi ke server.");
                updateButtons('ERROR'); 
                isMyAction = false; // Reset kalau gagal
            }
        };

        // Pasang Event Listener
        btnHandle.onclick = () => changeStatus('Sedang Ditangani');
        btnDone.onclick = () => changeStatus('Selesai');
        btnActivate.onclick = () => changeStatus('Aktif');


        // ============================================
        // 4. HELPER FUNCTIONS
        // ============================================
        function getStatusColor(status) {
            if (status === 'Aktif') return 'red';
            if (status === 'Sedang Ditangani') return 'yellow';
            return 'green';
        }

        function updateButtons(currentStatus) {
            const allBtns = document.querySelectorAll('.status-btn');
            allBtns.forEach(btn => btn.disabled = false);
            if (currentStatus === 'Aktif') btnActivate.disabled = true;
            if (currentStatus === 'Sedang Ditangani') btnHandle.disabled = true;
            if (currentStatus === 'Selesai') btnDone.disabled = true;
        }

        function updateRiskAndPriority(riskLevel) {
            const riskEl = document.getElementById("riskLevel");
            const priorityEl = document.getElementById("prioritas");
            const currentRisk = (riskLevel || 'NORMAL').toUpperCase();

            riskEl.textContent = currentRisk;
            if(currentRisk === 'CRITICAL' || currentRisk === 'HIGH') {
                riskEl.style.color = 'red';
                riskEl.style.fontWeight = 'bold';
            } else {
                riskEl.style.color = '#c62828';
            }

            let priorityText = "Rendah";       
            let priorityClass = "priority low"; 
            if (currentRisk === 'CRITICAL') {
                priorityText = "Sangat Tinggi (Bahaya)";
                priorityClass = "priority critical";
            } else if (currentRisk === 'HIGH') {
                priorityText = "Tinggi";
                priorityClass = "priority high";
            } else if (currentRisk === 'MEDIUM') {
                priorityText = "Menengah";
                priorityClass = "priority medium";
            }
            priorityEl.textContent = priorityText;
            priorityEl.className = priorityClass;
        }

        function updateMap(lokasi) {
            const rawLoc = lokasi ? lokasi.replace(/\s/g, '') : ''; 
            const mapFrame = document.getElementById("mapFrame");
            const coordEl = document.getElementById("koordinat");
            const mapsLinkUrl = `https://www.google.com/maps?q=${rawLoc}`;
            
            coordEl.innerHTML = `<a href="${mapsLinkUrl}" target="_blank" class="maps-link" style="display: inline-flex; align-items: center; gap: 8px; color: #1976d2; text-decoration: none; font-weight: 600; background-color: #e3f2fd; padding: 8px 12px; border-radius: 20px; margin-top: 5px;"><i class="fa-solid fa-location-arrow"></i> ${lokasi} <span style="font-size: 0.8em; color: #666;">(Buka di Google Maps)</span></a>`;

            if (rawLoc && rawLoc.includes(',')) {
                mapFrame.src = `https://maps.google.com/maps?q=${rawLoc}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
                mapFrame.style.display = 'block';
            } else {
                mapFrame.style.display = 'none';
            }
        }

        function updateGallery(image) {
            const galleryContainer = document.getElementById('galleryContainer');
            if (image) { 
              galleryContainer.innerHTML = `<div class="single-photo-container"><img src="${image}" alt="Foto Kejadian"></div>`;
            } else {
              galleryContainer.innerHTML = '<p style="color: #777; font-size: 0.9rem;">Tidak ada dokumentasi foto.</p>';
            }
        }

        function formatTanggalDariID(hexId) {
            try {
                const timestamp = parseInt(hexId.substring(0, 8), 16) * 1000;
                return new Date(timestamp).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
            } catch (e) { return "Tanggal tidak valid"; }
        }

        function fetchDetail() {
            fetch(`/api/laporan/${laporanId}`)
              .then(res => {
                  if(!res.ok) throw new Error("Laporan tidak ditemukan");
                  return res.json();
              })
              .then(data => updateUI(data))
              .catch(err => { console.error(err); alert("Gagal memuat data laporan."); });
        }

        // ============================================
        // 5. SOCKET LISTENERS (REAL-TIME BACKUP)
        // ============================================
        socket.on('laporan-diperbarui', (updatedData) => {
            if (updatedData._id === laporanId) {
                updateUI(updatedData);
                
                // LOGIKA PENTING: Hanya muncul notif jika BUKAN kita yang pencet
                if (!isMyAction) { 
                    if(typeof showToastNotification === 'function') {
                        showToastNotification({ title: 'Status Diperbarui Admin Lain', time: 'Baru saja', icon: 'üìù' });
                    }
                }
            }
        });

        socket.on('laporan-masuk', (laporanBaru) => {
             if(typeof addNewNotification === 'function') {
                 addNewNotification({ id: laporanBaru._id, location: laporanBaru.lokasi, time: laporanBaru.waktu });
             }
        });

        fetchDetail();
      });
   </script>
  </body>
</html>