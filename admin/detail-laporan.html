<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Laporan - SIPADAM Admin</title>
    
    <link rel="stylesheet" href="detail-laporan.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        .detail-container { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; max-width: 1400px; margin: 0 auto; }
        .detail-card { background: #fff; border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); margin-bottom: 25px; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; color: #2c3e50; border-left: 4px solid #8B0000; padding-left: 12px; }
        
        .main-status-banner { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); margin-bottom: 25px; }
        .report-id-group h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; color: #2c3e50; }
        
        .big-status-badge { padding: 10px 20px; border-radius: 30px; font-weight: 700; text-transform: uppercase; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .big-status-badge.red { background: #ffebee; color: #d32f2f; }
        .big-status-badge.yellow { background: #fff8e1; color: #f57c00; }
        .big-status-badge.green { background: #e8f5e9; color: #388e3c; }

        .sensor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .sensor-card { padding: 20px; border-radius: 16px; text-align: center; transition: 0.2s; }
        .sensor-card:hover { transform: translateY(-3px); }
        .sensor-value { font-size: 1.3rem; font-weight: 700; color: #333; }

        #mapFrame { width: 100%; height: 350px; border-radius: 12px; margin-top: 15px; border: none; background: #eee; }
        
        .action-sticky { position: sticky; top: 20px; }
        .action-buttons { display: flex; flex-direction: column; gap: 12px; }
        .btn-modern { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; }
        .btn-modern:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-modern:active { transform: scale(0.98); }
        
        .btn-handle { background: linear-gradient(135deg, #fbc02d, #f57f17); }
        .btn-done { background: linear-gradient(135deg, #43a047, #2e7d32); }
        .btn-activate { background: linear-gradient(135deg, #e53935, #c62828); }

        .risk-badge { background: #ffebee; color: #c62828; padding: 15px; border-radius: 12px; text-align: center; font-weight: 700; border: 2px solid #ef5350; margin-top: 20px; }

        @media (max-width: 992px) { .detail-container { grid-template-columns: 1fr; } .action-sticky { position: static; } }
    </style>
</head>
<body>

    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="icon">üî•</span>
          <div class="logo-text"><h2>SIPADAM</h2><p>Admin Panel</p></div>
        </div>
      </div>
      <ul class="menu">
        <li><a href="dashboard.html"><span class="icon">üìä</span><span class="menu-text">Dashboard</span></a></li>
        <li class="active"><a href="laporan.html"><span class="icon">üìã</span><span class="menu-text">Laporan</span></a></li>
        <li><a href="profil.html"><span class="icon">üë§</span><span class="menu-text">Profil</span></a></li>
        <li><a href="login.html"><span class="icon">üö™</span><span class="menu-text">Keluar</span></a></li>
      </ul>
    </div>

    <div class="main-content">
      <header>
        <div class="header-left">
          <div class="menu-toggle" id="menu-toggle-btn">‚ò∞</div>
          <h1>Detail Laporan</h1>
        </div>
        <div class="user-info">
          <div class="notification-area">
            <a href="#" class="notif" id="notificationBell">üîî<span class="badge" id="notificationBadge"></span></a>
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="dropdown-header"><h3>Notifikasi</h3><span class="clear-all" id="clearAllNotifications">Bersihkan</span></div>
              <div class="dropdown-list" id="notificationList"></div>
              <div class="dropdown-footer"><a href="laporan.html">Lihat Semua</a></div>
            </div>
          </div>
          <a href="profil.html" class="user"> üë©‚Äçüöí Petugas Pemadam </a>
          <span class="status online">Online</span>
        </div>
      </header>

      <button class="back-btn" onclick="window.location.href='laporan.html'" style="margin-bottom: 20px;">
        ‚¨Ö Kembali ke Daftar
      </button>

      <div id="error-message" style="display: none; background: #ffebee; color: #c62828; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; border: 1px solid #ef5350;"></div>

      <div class="detail-container">
        <div class="left-column">
            <div class="main-status-banner">
                <div class="report-id-group">
                    <h2 id="judulLaporan">Memuat Data...</h2>
                    <span class="report-time"><i class="fa-regular fa-clock"></i> <span id="waktuLaporan">--</span></span>
                </div>
                <div id="statusBadge" class="big-status-badge red"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>
            </div>

            <div class="detail-card">
                <h3 class="card-title">Data Sensor</h3>
                <div class="sensor-grid">
                    <div class="sensor-card" style="background: #fff5f5;"><div class="sensor-icon" style="color: #e53935;">üî•</div><h4>Suhu</h4><div class="sensor-value" id="suhu">--¬∞C</div></div>
                    <div class="sensor-card" style="background: #e3f2fd;"><div class="sensor-icon" style="color: #1976d2;">üíß</div><h4>Kelembaban</h4><div class="sensor-value" id="kelembaban">--%</div></div>
                    <div class="sensor-card" style="background: #fff3e0;"><div class="sensor-icon" style="color: #ef6c00;">üí®</div><h4>Asap</h4><div class="sensor-value" id="intensitas">-- ppm</div></div>
                    <div class="sensor-card" style="background: #e8f5e9;"><div class="sensor-icon" style="color: #2e7d32;">‚ò†Ô∏è</div><h4>Gas CO</h4><div class="sensor-value" id="co">-- ppm</div></div>
                </div>
            </div>

            <div class="detail-card">
                <h3 class="card-title">Lokasi & Info</h3>
                <p><strong>Alamat:</strong> <span id="alamat">Memuat...</span></p>
                <p><strong>Catatan:</strong> <span id="deskripsi">--</span></p>
                <div id="koordinatLink" style="margin-top: 10px;"></div>
                <iframe id="mapFrame" loading="lazy"></iframe>
            </div>

            <div class="detail-card">
                <h3 class="card-title">Foto Bukti</h3>
                <div id="galleryContainer" style="text-align: center; color: #888; padding: 20px;">Memuat foto...</div>
            </div>
        </div> 

        <div class="right-column">
            <div class="detail-card action-sticky">
                <h3 class="card-title" style="border-color: #f9a825;">Aksi Status</h3>
                <div class="action-buttons">
                    <button class="btn-modern btn-handle" id="btn-handle" onclick="updateStatus('Sedang Ditangani')">
                        <i class="fa-solid fa-helmet-safety"></i> Tandai Sedang Ditangani
                    </button>
                    <button class="btn-modern btn-done" id="btn-done" onclick="updateStatus('Selesai')">
                        <i class="fa-solid fa-circle-check"></i> Tandai Selesai
                    </button>
                    <button class="btn-modern btn-activate" id="btn-activate" onclick="updateStatus('Aktif')">
                        <i class="fa-solid fa-fire"></i> Aktifkan Kembali
                    </button>
                </div>
                <div class="risk-badge">
                    <p style="font-size: 0.8rem; margin-bottom: 5px;">TINGKAT RISIKO</p>
                    <span id="riskLevel">NORMAL</span>
                </div>
            </div>
        </div>
      </div>
    </div>

   <script src="main.js"></script>
   
   <script>
      // Ambil ID Laporan dari URL (Contoh: detail-laporan.html?id=123)
      const params = new URLSearchParams(window.location.search);
      const laporanId = params.get("id");
      let socket; // Definisikan socket di luar agar global

      document.addEventListener('DOMContentLoaded', () => {
        console.log("üöÄ Halaman Detail Laporan Dimuat...");

        // 1. CEK ID LAPORAN
        if (!laporanId) {
            showError("ID Laporan tidak ditemukan di URL. Silakan kembali ke halaman Laporan dan klik tombol 'Detail' pada salah satu item.");
            return; // Hentikan script jika ID tidak ada
        }

        // 2. INISIALISASI SOCKET (Dengan Error Handling)
        try {
            socket = io();
            socket.emit('admin-bergabung');
            console.log("‚úÖ Socket terhubung.");
            
            // Listener Update Realtime
            socket.on('laporan-diperbarui', (updatedData) => {
                if (updatedData._id === laporanId) {
                    console.log("üîÑ Mendapat update realtime:", updatedData);
                    renderUI(updatedData);
                    if (typeof showToastNotification === 'function') {
                        showToastNotification({ title: 'Update Data', message: 'Data diperbarui otomatis', icon: 'üîÑ' });
                    }
                }
            });
        } catch (e) {
            console.warn("‚ö†Ô∏è Socket.io tidak terhubung (Mungkin server mati), tapi tombol harus tetap jalan via API.", e);
        }

        // 3. AMBIL DATA DARI SERVER
        fetchDetail();
      });

      // --- FUNGSI AMBIL DATA ---
      async function fetchDetail() {
          try {
              console.log(`üì° Mengambil data laporan ID: ${laporanId}...`);
              const response = await fetch(`/api/laporan/${laporanId}`);
              
              if (!response.ok) throw new Error("Gagal mengambil data (404/500)");
              
              const data = await response.json();
              console.log("‚úÖ Data diterima:", data);
              renderUI(data);

          } catch (err) {
              console.error("‚ùå Error Fetch:", err);
              showError(`Gagal memuat data: ${err.message}. Pastikan server berjalan.`);
          }
      }

      // --- FUNGSI UPDATE TAMPILAN (RENDER) ---
      function renderUI(data) {
          // Header
          setText('judulLaporan', `Laporan #${data._id.substring(0, 6)}`);
          setText('waktuLaporan', data.waktu);
          
          // Badge Status
          const badge = document.getElementById('statusBadge');
          let badgeClass = 'red', badgeIcon = 'fa-fire', badgeText = data.status;
          
          if(data.status === 'Sedang Ditangani') { badgeClass = 'yellow'; badgeIcon = 'fa-helmet-safety'; }
          if(data.status === 'Selesai') { badgeClass = 'green'; badgeIcon = 'fa-check'; }
          
          badge.className = `big-status-badge ${badgeClass}`;
          badge.innerHTML = `<i class="fa-solid ${badgeIcon}"></i> ${badgeText}`;

          // Sensor
          setText('suhu', data.suhu ? `${data.suhu}¬∞C` : '--');
          setText('kelembaban', data.kelembaban ? `${data.kelembaban}%` : '--');
          setText('intensitas', data.intensitas ? `${data.intensitas} ppm` : '--');
          setText('co', data.co ? `${data.co} ppm` : '--');
          
          // Lokasi & Info
          setText('alamat', data.lokasi);
          setText('deskripsi', data.catatan || '-');
          setText('riskLevel', (data.riskLevel || 'NORMAL').toUpperCase());

          // Peta (Google Maps Embed)
          const mapFrame = document.getElementById('mapFrame');
          const linkDiv = document.getElementById('koordinatLink');
          if (data.lokasi) {
              const cleanLoc = data.lokasi.replace(/\s/g, ''); // Hapus spasi
              const mapUrl = `https://maps.google.com/maps?q=${cleanLoc}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
              mapFrame.src = mapUrl;
              linkDiv.innerHTML = `<a href="https://maps.google.com/?q=${cleanLoc}" target="_blank" style="color:#1976d2;text-decoration:none;font-weight:600;">üìç Buka di Google Maps</a>`;
          }

          // Foto
          const gallery = document.getElementById('galleryContainer');
          if (data.image) {
              gallery.innerHTML = `<img src="${data.image}" style="width:100%; border-radius:8px; border:1px solid #ddd;" alt="Bukti Foto">`;
          } else {
              gallery.innerHTML = `<div style="padding:30px;background:#f9f9f9;border-radius:8px;">üì∑ Tidak ada foto.</div>`;
          }
      }

      // --- FUNGSI UPDATE STATUS (TOMBOL) ---
      async function updateStatus(newStatus) {
          console.log(`üñ±Ô∏è Tombol ditekan: Ubah ke ${newStatus}`);
          
          // Animasi Loading Tombol (Feedback ke User)
          const btnId = newStatus === 'Selesai' ? 'btn-done' : (newStatus === 'Aktif' ? 'btn-activate' : 'btn-handle');
          const btn = document.getElementById(btnId);
          const originalText = btn.innerHTML;
          btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Proses...`;
          btn.disabled = true;

          try {
              const response = await fetch(`/api/laporan/${laporanId}/status`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ status: newStatus }),
              });

              if (!response.ok) throw new Error("Gagal update status di server");

              const dataBaru = await response.json();
              console.log("‚úÖ Status berhasil diubah:", dataBaru);
              
              // Update Tampilan
              renderUI(dataBaru);
              
              // Notifikasi Sukses
              if(typeof showToastNotification === 'function') {
                  showToastNotification({ title: 'Berhasil', message: `Status diubah ke ${newStatus}`, icon: '‚úÖ' });
              } else {
                  alert(`Status berhasil diubah ke: ${newStatus}`);
              }

          } catch (err) {
              console.error("‚ùå Gagal update status:", err);
              alert("Gagal mengubah status. Periksa koneksi server.");
          } finally {
              // Kembalikan tombol
              btn.innerHTML = originalText;
              btn.disabled = false;
          }
      }

      // Helper Text Setter (Biar gak error kalau elemen null)
      function setText(id, text) {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
      }

      // Helper Tampilkan Error
      function showError(msg) {
          const errBox = document.getElementById('error-message');
          errBox.style.display = 'block';
          errBox.textContent = `‚ùå ERROR: ${msg}`;
          document.querySelector('.detail-container').style.display = 'none'; // Sembunyikan konten jika error fatal
      }
   </script>
</body>
</html>