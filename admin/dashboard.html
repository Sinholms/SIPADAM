<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - SIPADAM</title>
    
    <link rel="stylesheet" href="dashboard.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="icon">üî•</div>
          <div class="logo-text">
            <h2>SIPADAM</h2>
            <p>Admin Panel</p>
          </div>
        </div>
      </div>
      <ul class="menu">
        <li class="active">
          <a href="dashboard.html">
            <span>üìä</span><span class="menu-text">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="laporan.html">
            <span>üìã</span><span class="menu-text">Laporan</span>
          </a>
        </li>
        <li>
          <a href="profil.html">
            <span>üë§</span><span class="menu-text">Profil</span>
          </a>
        </li>
        <li>
          <a href="login.html">
            <span>üö™</span><span class="menu-text">Keluar</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="main-content">
      <header>
        <div class="header-left">
          <div class="menu-toggle" id="menu-toggle-btn">‚ò∞</div>
          <h1>Dashboard</h1>
        </div>
        
        <div class="user-info">
          <div class="notification-area">
            <a href="#" class="notif" id="notificationBell">
              üîî<span class="badge" id="notificationBadge" style="display: none;"></span>
            </a>
            
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="dropdown-header">
                <h3>Notifikasi Terbaru</h3>
                <span class="clear-all" id="clearAllNotifications">Bersihkan</span>
              </div>
              <div class="dropdown-list" id="notificationList">
                </div>
              <div class="dropdown-footer">
                <a href="laporan.html">Lihat Semua Laporan</a>
              </div>
            </div>
          </div>

          <a href="profil.html" class="user"> üë©‚Äçüöí Petugas Pemadam </a>
          <span class="status">Online</span>
        </div>
      </header>

      <div class="cards">
        
        <div class="card blue">
          <div class="card-content">
            <h3>Total Laporan</h3>
            <p class="number" id="total-laporan">0</p> 
          </div>
          <div class="card-icon-overlay">üìÑ</div>
        </div>

        <div class="card red">
          <div class="card-content">
            <h3>Laporan Aktif</h3>
            <p class="number" id="laporan-aktif">0</p> 
          </div>
          <div class="card-icon-overlay">üî•</div>
        </div>

        <div class="card orange">
          <div class="card-content">
            <h3>Sedang Ditangani</h3>
            <p class="number" id="penanganan">0</p> 
          </div>
          <div class="card-icon-overlay">‚è≥</div>
        </div>

      </div>

      <div class="content-grid">
        <div class="map-card">
          <div class="map-header">
            <h3>Peta Lokasi Kebakaran</h3>
            <button class="btn-secondary" onclick="zoomMap()">Perbesar</button>
          </div>
          <div
            id="map"
            style="width: 100%; height: 350px;"
          ></div>
        </div>

        <div class="report-card">
          <div class="report-header">
            <h3>Laporan Terbaru</h3>
            <button
              class="btn-secondary"
              onclick="location.href='laporan.html'"
            >
              Lihat Semua
            </button>
          </div>
          <div class="report-list" id="report-list-container">
            <p class="no-reports-message" style="padding: 15px; text-align: center; color: #777;">Belum ada laporan terbaru.</p>
          </div>
        </div>
      </div>
    </div>

    <script
      defer
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    ></script>
    
    <script src="/socket.io/socket.io.js"></script>

    <script defer src="main.js"></script>
    <script defer src="dashboard.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
          
          const adminSocket = io();
          adminSocket.emit('admin-bergabung');
          console.log('Admin Dashboard: Bergabung ke ruangan admin...');

          const reportListContainer = document.getElementById('report-list-container');
          const laporanAktifCounter = document.getElementById('laporan-aktif');
          const penangananCounter = document.getElementById('penanganan');
          const totalLaporanCounter = document.getElementById('total-laporan'); 

          // 1. UPDATE TOTAL LAPORAN AWAL
          fetch('/api/laporan')
            .then(res => res.json())
            .then(data => {
                if(totalLaporanCounter) totalLaporanCounter.textContent = data.length;
            })
            .catch(err => console.error("Gagal memuat total laporan:", err));

          // 2. SOCKET: MUAT LAPORAN LAMA
          adminSocket.on('muat-laporan-lama', (laporanLama) => {
            if (laporanLama && laporanLama.length > 0) {
              const noReports = reportListContainer.querySelector('.no-reports-message');
              if (noReports) noReports.remove();
            
              laporanLama.forEach(dataLaporan => {
                buatElemenLaporan(dataLaporan, false); 
              });

              const laporanAktif = laporanLama.filter(l => l.status === 'Aktif').length;
              const laporanPenanganan = laporanLama.filter(l => l.status === 'Sedang Ditangani').length;
              
              if(laporanAktifCounter) laporanAktifCounter.textContent = laporanAktif;
              if(penangananCounter) penangananCounter.textContent = laporanPenanganan;

              if (typeof updateNotificationCount === 'function') {
                  updateNotificationCount(laporanAktif);
              } else {
                  // Fallback jika fungsi notifikasi di main.js belum siap
                  const notifBadge = document.getElementById('notificationBadge');
                  if (notifBadge) {
                      notifBadge.textContent = laporanAktif > 0 ? laporanAktif : '';
                      notifBadge.style.display = laporanAktif > 0 ? 'block' : 'none';
                  }
              }
            }
          });

          // 3. SOCKET: LAPORAN BARU MASUK
          adminSocket.on('laporan-masuk', (dataLaporan) => {
              // Panggil fungsi notifikasi dari main.js
              if (typeof addNewNotification === 'function') {
                addNewNotification(dataLaporan);
              }

              // Update counter
              if (laporanAktifCounter) {
                  let currentCount = parseInt(laporanAktifCounter.textContent) || 0;
                  laporanAktifCounter.textContent = currentCount + 1;
              }
              if (totalLaporanCounter) {
                  let currentTotal = parseInt(totalLaporanCounter.textContent) || 0;
                  totalLaporanCounter.textContent = currentTotal + 1;
              }

              // List & Map
              buatElemenLaporan(dataLaporan, true);
              
              // Tambah marker peta
              try {
                if (typeof addFireMarkerToMap === 'function') {
                  const coordArray = dataLaporan.lokasi.split(",").map(Number);
                  if (coordArray.length === 2 && !isNaN(coordArray[0]) && !isNaN(coordArray[1])) {
                    const popupContent = `
                      <div style="font-family: 'Poppins', sans-serif; font-size: 0.9rem;">
                        <h4 style="color: #e53935; margin: 0 0 5px 0;">Laporan Baru!</h4>
                        <p style="margin: 0;"><strong>Lokasi:</strong> ${dataLaporan.lokasi}</p>
                        <p style="margin: 5px 0 0 0;"><strong>Catatan:</strong> ${dataLaporan.catatan || 'Tidak ada'}</p>
                        <a href="detail-laporan.html?id=${dataLaporan._id}" target="_blank" style="margin-top: 8px; display: inline-block;">Lihat Detail</a>
                      </div>
                    `;
                    addFireMarkerToMap(coordArray, popupContent);
                  }
                }
              } catch (e) { console.error("Map error:", e); }
          });

          // 4. SOCKET: UPDATE STATUS
          adminSocket.on('laporan-diperbarui', (laporanDiperbarui) => {
            if (reportListContainer) {
              const itemToUpdate = reportListContainer.querySelector(`#laporan-${laporanDiperbarui._id}`);
              if (itemToUpdate) {
                itemToUpdate.remove();
                buatElemenLaporan(laporanDiperbarui, true); 
              }
            }
            // Request update data terbaru untuk sinkronisasi counter
            adminSocket.emit('admin-bergabung'); 
          });

          // --- FUNGSI BUAT ELEMEN HTML (TAMPILAN MODERN) ---
          function buatElemenLaporan(data, taruhDiAtas) {
            if (reportListContainer) {
                const noReports = reportListContainer.querySelector('.no-reports-message');
                if (noReports) noReports.remove();

                const newItem = document.createElement('div');
                newItem.className = 'report-item';
                newItem.id = `laporan-${data._id}`; 
                
                let statusBadge = '';
                // Badge Style Baru
                if (data.status === 'Aktif') {
                  statusBadge = `<span class="status-badge aktif">üî• Aktif</span>`;
                } else if (data.status === 'Sedang Ditangani') {
                   statusBadge = `<span class="status-badge penanganan">‚è≥ Ditangani</span>`;
                } else {
                  statusBadge = `<span class="status-badge selesai">‚úÖ Selesai</span>`;
                }

                newItem.innerHTML = `
                    <div class="report-top">
                        <div>
                          <h4>${data.lokasi}</h4>
                          <p>${data.catatan || 'Tidak ada catatan.'}</p>
                        </div>
                        ${statusBadge}
                    </div>
                    <div class="report-meta">
                        <span class="report-time">üïí ${data.waktu}</span>
                        <span class="report-link">Lihat Detail &rarr;</span>
                    </div>
                `;
                
                newItem.onclick = () => {
                  window.location.href = `detail-laporan.html?id=${data._id}`;
                };
                
                if (taruhDiAtas) {
                  reportListContainer.prepend(newItem);
                } else {
                  reportListContainer.append(newItem);
                }
            }
          }
      });
    </script>
  </body>
</html>